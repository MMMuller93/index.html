<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EDGAR Form ID — Replacer & PDF</title>

<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
  :root { --bg:#0b0f14; --fg:#e8edf2; --muted:#9aa7b2; --card:#121821; --acc:#4ba3ff; --ok:#46d160; --warn:#ffcc66; --err:#ff6b6b; --bord:#243244; }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 12px}
  p.sub{color:var(--muted);margin:0 0 24px}
  .card{background:var(--card);border:1px solid var(--bord);border-radius:14px;padding:18px;margin-bottom:18px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
  label{display:block;font-weight:600;margin:0 0 6px}
  input[type="text"]{width:100%;box-sizing:border-box;background:#0f1520;border:1px solid var(--bord);color:var(--fg);padding:10px 12px;border-radius:10px}
  textarea#preview{width:100%;min-height:220px;background:#0f1520;border:1px solid var(--bord);color:var(--fg);padding:10px 12px;border-radius:10px}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  button{cursor:pointer;border:1px solid var(--bord);background:#122034;color:var(--fg);padding:10px 14px;border-radius:10px}
  button.primary{background:var(--acc);border-color:var(--acc);color:#031b33;font-weight:700}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid var(--bord);background:#0d141e}
  .ok{color:var(--ok);border-color:#28402c;background:#0f1a12}
  .warn{color:var(--warn);border-color:#4a3b1a;background:#16140f}
  .err{color:var(--err);border-color:#4a1f1f;background:#180f10}
  .footer{color:var(--muted);font-size:12px;margin-top:24px}

  /* Print/PDF */
  @page { size: Letter; margin: 0.5in; }
  @media print {
    .page-break { break-before: page !important; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>EDGAR Form ID — Replacer & PDF</h1>
    <p class="sub">Enter the new fund name and EIN, then download an edited <b>HTML</b> or a ready-to-send <b>PDF</b>. Everything runs locally in your browser.</p>

    <div class="card">
      <div class="row">
        <div>
          <label for="newName">New Fund Name</label>
          <input id="newName" type="text" placeholder="e.g., New Fund LP" />
          <div class="hint">Replaces: <code>Goodfin II, a Series of E1 VC, LLC</code></div>
        </div>
        <div>
          <label for="newEin">New EIN</label>
          <input id="newEin" type="text" placeholder="e.g., 12-3456789 or 123456789" />
          <div class="hint">Replaces: <code>394238343</code></div>
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="previewBtn">Preview changes</button>
        <button id="downloadHtmlBtn">Download HTML</button>
        <button id="downloadPdfBtn">Download PDF</button>
        <button id="printBtn">Print to PDF</button>
        <span id="status" class="badge">Idle</span>
      </div>
    </div>

    <div class="card">
      <label for="preview">Edited HTML (read-only preview)</label>
      <textarea id="preview" readonly placeholder="Click Preview to generate…"></textarea>
    </div>

    <div class="footer">
      Tip: put <code>form_id_base.html</code> (your base HTML) in this same folder so the page loads it automatically.  
      If you prefer an all-in-one file, paste your base HTML once into the <b>EMBEDDED BASE HTML</b> block below and remove the loader URL line.
    </div>
  </div>

  <!-- Load html2pdf (includes html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIP0R1qHn2mWkU3FZ+2d8bqjQJ3m7f6E7B9o8Q9W0z1oYQ0Nw2b3Q0gq2wC8g8X8h0p7oYcW3k5OqD9B1g0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- BEGIN EMBEDDED BASE HTML (optional, paste your full base HTML between the backticks) -->
  <script id="embeddedBase" type="text/plain">
<!-- Paste your ENTIRE provided HTML here if you want a single-file setup.
     Otherwise, leave this empty and keep the loader URL below. -->
  </script>
  <!-- END EMBEDDED BASE HTML -->

<script>
/** Configuration **/
const DEFAULT_NAME = "Goodfin II, a Series of E1 VC, LLC";
const DEFAULT_EIN  = "394238343";

/* If you commit form_id_base.html next to this file, we’ll load it;
   otherwise we fall back to the EMBEDDED BASE HTML block above. */
const DEFAULT_SOURCE_URL = "form_id_base.html";

/* anchors that must start on a new page */
const PAGE_BREAK_ANCHORS = [
  "PART 2 - COMPANY APPLICANT INFORMATION",
  "PART 3 - ACCOUNT ADMINISTRATOR INFORMATION",
  "PART 4 - BILLING INFORMATION",
  "PART 5 - SIGNATURE",
  "FORM ID - NOTARIZED AUTHENTICATION"
];

/** Helpers **/
function setStatus(msg, cls=''){ const s=document.getElementById('status'); s.textContent=msg; s.className='badge '+cls; }

function replaceAllLiteral(haystack, needle, replacement){
  const parts = haystack.split(needle);
  return { text: parts.join(replacement), count: Math.max(0, parts.length-1) };
}

function injectPrintCss(doc){
  const style = doc.createElement('style');
  style.textContent = `
    @page { size: Letter; margin: 0.5in; }
    @media print { .page-break { break-before: page !important; } 
                   body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
  `;
  doc.head.appendChild(style);
}

function insertPageBreaks(doc){
  const candidates = doc.querySelectorAll('p, h1, h2, h3, span, div, table');
  PAGE_BREAK_ANCHORS.forEach(anchor=>{
    for (const el of candidates){
      if (!el || !el.textContent) continue;
      if (el.textContent.trim().includes(anchor)){
        // climb to a sensible block container
        let target = el;
        const isBlock = n => n && /^(P|H1|H2|DIV|TABLE|TBODY|TR)$/i.test(n.tagName||"");
        while (target && !isBlock(target)) target = target.parentElement;
        if (!target) target = el;
        const br = doc.createElement('div');
        br.className = 'page-break';
        target.parentElement.insertBefore(br, target);
        break;
      }
    }
  });
}

function makeEditedHtml(baseHtml, newName, newEin){
  // literal string replacements
  let edited = baseHtml;
  edited = replaceAllLiteral(edited, DEFAULT_NAME, newName).text;
  edited = replaceAllLiteral(edited, DEFAULT_EIN, newEin).text;

  // parse, add page breaks + print CSS, reserialize
  const parser = new DOMParser();
  const doc = parser.parseFromString(edited, 'text/html');
  injectPrintCss(doc);
  insertPageBreaks(doc);
  return "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
}

async function loadBaseHtml(){
  // try external file
  try{
    const res = await fetch(DEFAULT_SOURCE_URL, {cache:'no-store'});
    if (res.ok) return await res.text();
  }catch(e){/* ignore */}
  // fallback to embedded script block
  const t = document.getElementById('embeddedBase')?.textContent?.trim();
  if (t) return t;
  throw new Error("Base HTML not found. Either add form_id_base.html or paste your base into the EMBEDDED block.");
}

/** UI wiring **/
const $ = sel => document.querySelector(sel);
const newName = $('#newName');
const newEin  = $('#newEin');
const preview = $('#preview');

let BASE_HTML_CACHE = "";

$('#previewBtn').addEventListener('click', async ()=>{
  if (!newName.value.trim() || !newEin.value.trim()){
    setStatus('Enter fund name and EIN', 'err'); return;
  }
  try{
    if (!BASE_HTML_CACHE) BASE_HTML_CACHE = await loadBaseHtml();
    const html = makeEditedHtml(BASE_HTML_CACHE, newName.value.trim(), newEin.value.trim());
    preview.value = html;
    setStatus('Preview ready', 'ok');
  }catch(e){ setStatus(e.message, 'err'); }
});

$('#downloadHtmlBtn').addEventListener('click', async ()=>{
  if (!newName.value.trim() || !newEin.value.trim()){
    setStatus('Enter fund name and EIN', 'err'); return;
  }
  try{
    if (!BASE_HTML_CACHE) BASE_HTML_CACHE = await loadBaseHtml();
    const html = makeEditedHtml(BASE_HTML_CACHE, newName.value.trim(), newEin.value.trim());
    const blob = new Blob([html], {type:'text/html;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'form_id.updated.html';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    setStatus('HTML downloaded', 'ok');
  }catch(e){ setStatus(e.message, 'err'); }
});

$('#downloadPdfBtn').addEventListener('click', async ()=>{
  if (!newName.value.trim() || !newEin.value.trim()){
    setStatus('Enter fund name and EIN', 'err'); return;
  }
  try{
    setStatus('Rendering PDF…');
    if (!BASE_HTML_CACHE) BASE_HTML_CACHE = await loadBaseHtml();
    const html = makeEditedHtml(BASE_HTML_CACHE, newName.value.trim(), newEin.value.trim());

    // Parse to DOM and render in a sandbox container for html2pdf
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    const sandbox = document.createElement('div');
    sandbox.style.background = '#fff';
    sandbox.style.color = '#000';
    // Width to match Letter minus margins (612pt - 2*36pt = 540pt); we use 564pt for a 24pt margin in html2pdf options below.
    sandbox.style.width = '564pt';

    // preserve original styles
    const style = doc.querySelector('head style');
    if (style) {
      const s = document.createElement('style');
      s.textContent = style.textContent + "\n@media print { .page-break { break-before: page !important; } }";
      sandbox.appendChild(s);
    }
    const content = document.createElement('div');
    content.innerHTML = doc.body.innerHTML;
    sandbox.appendChild(content);
    document.body.appendChild(sandbox);

    const opt = {
      margin:       [24,24,24,24], // pt
      filename:     'form_id.updated.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
      jsPDF:        { unit: 'pt', format: 'letter', orientation: 'portrait' },
      pagebreak:    { mode: ['css', 'legacy'] }
    };
    await html2pdf().set(opt).from(sandbox).save();
    setStatus('PDF downloaded', 'ok');
    sandbox.remove();
  }catch(e){
    console.error(e);
    setStatus('PDF render failed. Try “Print to PDF”.', 'warn');
  }
});

$('#printBtn').addEventListener('click', async ()=>{
  if (!newName.value.trim() || !newEin.value.trim()){
    setStatus('Enter fund name and EIN', 'err'); return;
  }
  try{
    if (!BASE_HTML_CACHE) BASE_HTML_CACHE = await loadBaseHtml();
    const html = makeEditedHtml(BASE_HTML_CACHE, newName.value.trim(), newEin.value.trim());
    const w = window.open('', '_blank');
    if (!w){ setStatus('Popup blocked — allow popups', 'err'); return; }
    w.document.open(); w.document.write(html); w.document.close();
    w.onload = ()=> w.print();
    setStatus('Opened print dialog', 'ok');
  }catch(e){ setStatus(e.message, 'err'); }
});
</script>
</body>
</html>
